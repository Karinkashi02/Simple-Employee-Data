<!DOCTYPE html>
<HTML>
<head>
    <title>EMPLOYEE LIST</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
    <script src="function.js"></script>

    <script type="module">
        // window.onload = start;

        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        // --- Your Firebase Config ---
        const firebaseConfig = {
            //...
        }

        // --- Firebase Initialization and Authentication ---
        setLogLevel('debug');
        let db, auth, userId;

        window.onload = async () => {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }


            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated with user ID:", userId);
                    fetchAndRenderData();
                } else {
                    userId = crypto.randomUUID();
                    console.log("Signed in anonymously with ID:", userId);
                    fetchAndRenderData();
                }
            });
        };

        const appId = firebaseConfig.appId;

        // --- Data Fetching and Rendering ---
        window.fetchAndRenderData = () => {
            const tableBody = document.getElementById('pegawai-table-body');
            const dataRef = ref(db, `pegawai_data`);

            
            // Listen for data changes in real-time
            onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                tableBody.innerHTML = '';

                if (data) {
                    let counter = 1;
                    for (const key in data) {
                        const pegawai = data[key]; // direct object
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${counter}</td>
                            <td style="text-align: start;"><a href="./infopegawai.html?id=${key}">${pegawai.name || 'N/A'}</a></td>
                            <td>${pegawai.unit || 'N/A'}</td>
                        `;
                        tableBody.appendChild(row);
                        counter++;
                    }
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3">Tiada data pegawai.</td></tr>';
                }
            });
        };

        window.searchTable = () => {
            const input = document.getElementById('search-input');
            const filter = input.value.toLowerCase();
            const rows = document.getElementById('pegawai-table-body').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName('td')[1]; // NAMA column
                if (nameCell) {
                    const textValue = nameCell.textContent || nameCell.innerText;
                    if (textValue.toLowerCase().indexOf(filter) > -1) {
                        rows[i].style.display = "";
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }
        };
    </script>
</head>

<body>
    <!-- <div id="bait">
        <h1><--- Donation ðŸ˜‡</h1>
    </div> -->
    <div class="dev-button">
        <button onclick="window.location.href='./devs.html'" id="button" style="font-size: smaller; font-weight: bolder;">D<br>E<br>V<br>E<br>L<br>O<br>P<br>E<br>R</button>
    </div>

    <div class="search">  
        <h1 style="text-align: center; font-family: Courier New, Courier, monospace;">DATA EMPLOYEE</h1>  
        <input type="text" id="search-input" placeholder="Search..." onkeyup="searchTable()">
    </div>
    <table>
        <thead>
            <th style="width: 20px;">NO</th>
            <th style="width: 800px;">NAMA</th>
            <th style="width: 500px;">UNIT CAWANGAN</th>
        </thead>
        <tbody id="pegawai-table-body">
            <!-- Data will be dynamically inserted here -->
        </tbody>
    </table>

    <div class="adjustment">
        <button class="ADD" onclick="window.location.href='./addform.html';">+</button>
        <button class="MINUS"  onclick="window.location.href='./delform.html';">-</button>
    </div>
</body>
</HTML>